---
title: "Informative Title Name"
author: "GROUP NUMBER: ADD YOUR NAMES HERE"
date: November 24, 2022
subtitle: STA304 - Assignment 2
output:
  pdf_document: default
---

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(openintro)
library(tidyverse)
library(MASS)
```



## Introduction

<Here you should have a few paragraphs of text introducing the problem, getting the reader interested/ready for the rest of the report.>

<Introduce terminology.>

<Highlight hypotheses.>

<Optional: You can also include a description of each section of this report as a last paragraph.>
  
The main objective of this report is to use a regression model with post-stratification to predict the overall popular vote for the upcoming Canadian federal election (tentatively 2025).
  
    For the analysis involved in this report, we will use two types of data — the census data and the survey data. The 2017 General Social Survey or GSS will serve as our census data, this includes every non-institutionalized individual over the age of 15 that is residing in one of the ten provinces of Canada. This 2017 GSS data was collected from February 2nd to November 30th, 2017 via telephone. The 2019 Canadian Election Study (CES) phone survey will serve as our survey data, this includes Canadian citizens and permanent residents aged 18 and above. This data was collected during and after the 2019 Canadian federal election through computer-assisted telephone interviews.
  
    This analysis is important because we will combine a multiple logistic regression model with post-stratification. Here, post-stratification will allow us to adjust the weights of each of the predictor variables to represent the population. This would make our final predictive model built using sample data more accurate. More specifically, the variables “gender” and “age” will be used to conduct post-stratification.
  
    The research question for our multiple logistic regression model with post stratification can be framed as follows: “Are age, province of residence, party preference, income and previous voting record factors that predict if a person will vote for the Liberal Party of Canada?”.
  
    Furthermore, we can represent this question in the form of a null and alternative hypothesis. Here the null hypothesis states that none of the predictive covariates have a statistically significant relationship with our dependent variable. On the other hand, the alternative hypothesis states that at least one predictive covariate has a statistically significant relationship with our dependent variable.
  
$$H_0:\beta_0 =\beta_1 = ... = \beta_k = 0$$
$$H_0:\beta_0 =\beta_1 = ... = \beta_k \neq 0$$


    Overall, this hypothesis test is important because it will help us determine whether our model is statistically significant and whether it can actually predict if an individual will vote for the Liberal Party of Canada.
  
Lastly, our report will contain the following sections: “Data”, “Methods”, “Results”, “Conclusion” and “Bibliography”. 




## Data

<The 2017 General Social Survey data is a sample survey with a cross-sectional design, facilitated from February 2nd through to November 30th, 2017. The 
target population of the survey is all non-institutionalized persons above the age of 15, living in Canada. The survey uses telephone numbers combined 
with Statistics Canada’s Address Register to collect data via telephone. The data is subject to sampling and non-damping errors. The data collected is
used to meet two primary objectives; to monitor changes in living conditions and well-being of Canadian individuals and to gather information on specific 
social policy issues of current or arising interest. In order to meet these objectives data collected by the GSS contains core content and classification 
variables. The core content data contains information about individuals living conditions and well-being to help inform specific policies. Classification 
variables such as age, income, education, marital status, and sex help to classify population groups to better analyze the core data within them. In order 
to collect the data each of the ten provinces in Canada was divided into strata, and within the ten provinces, many of the Census Metropolitan Areas were 
considered separate strata, for a total of 27 strata. A simple random sample without replacement of records was performed within each stratum. The data 
was collected via computer-assisted telephone interviews. Responses from the interviews were entered directly into computers as the interview went on. The 
data was then electronically transmitted to Ottawa. Several questions in the data allowed for write-in responses. These responses were either categorized 
into existing groups or left in “other specify” if a match was not possible within the existing data. As the survey was conducted the computer would 
create edits and identify “out of range" values that the interviewer could clarify and resolve with the individual being surveyed. If issues were unable 
to be resolved the errors were forwarded to the Head Office for resolution. Non-response was not permitted for questions that the survey later required to
use for the weighting of individuals. In the case where important values were missing values were imputed.  In 2017, personal income information was not 
obtained through the survey but rather collected from tax data for the respondent. Finally, the timing that respondents experienced given life events was 
very important to the survey and was collected from individuals’ recollections. Originally the month and year of a particular event were asked, however, 
if individuals were unable or refused to provide such information then the age at which he or she experienced the event is asked. For some situations, the 
answers required imputation to derive the age, month, and year of the occurrence of events for individuals.>

In the 2019 Canadian Election Study, a Phone survey was conducted to gather information on the underlying reasons why people make the voting decisions 
they do, to evaluate what does and does not change during the campaign from one election to another, and to highlight similarities and differences between 
elections and voting in Canada to other democratic countries. The study was conducted on Canadian citizens and permanent residents age 18 or older during 
and after the 2019 federal election. The data was collected through computer-assisted telephone interviews, consisting of 4021 cases and 278 variables. 
The sample consisted of 66% wireless telephone numbers and 34% landline telephone numbers.>


```{r, include = FALSE}

# Here you can load in and clean the census data (you may need to do the cleaning in a separate R script). 

census_data <- read_csv("gss_clean.csv")
 
updated_census_data <- census_data %>% 
  mutate(province = 
           case_when(
             province == "Quebec" ~ "East",
             province == "Ontario" ~ "East",
             province == "New Brunswick" ~ "East",
             province == "Newfoundland and Labrador" ~ "East",
             province == "Nova Scotia" ~ "East",
             province == "Prince Edward Island" ~ "East",
             province == "Alberta" ~ "West",
             province == "Manitoba" ~ "West",
             province == "Saskatchewan" ~ "West",
             province == "British Columbia" ~ "West"),
         religion_important = case_when(
           regilion_importance == "Very important" ~ 1,
           regilion_importance == "Somewhat important" ~ 1,
           regilion_importance == "Not very important" ~ 0,
           regilion_importance == "Not at all important" ~ 0,
           regilion_importance == "Don't know" ~ 0
         ),
         age=case_when(
           age >= 18 & age <=29 ~ "ages 18 to 29",
           age >= 30 & age <=44 ~ "ages 30 to 44",
           age >= 45 & age <= 59 ~ "ages 45 to 59",
           age >= 60 ~ "ages 60 plus",
         ),
         completed_university = case_when(
           education == "Bachelor's degree (e.g. B.A., B.Sc., LL.B.)" | 
             education == "University certificate or diploma below the bachelor's level" | 
             education == "University certificate, diploma or degree above the bach..." ~ 1,
           education == "College, CEGEP or other non-university certificate or di..." | 
             education == "High school diploma or a high school equivalency certificate" |
             education == "Less than high school diploma or its equivalent" |
             education == "Trade certificate or diploma" ~ 0
         ),
         married = ifelse(marital_status == "Married", 1,0),
         employed = ifelse(worked_last_week == "Yes", 1,0),
         
         
  ) %>%  dplyr::select (province, religion_important, age, income_family, completed_university, married, employed)
updated_census_data <- na.omit(updated_census_data)

updated_census_data1 <- updated_census_data %>%
  group_by(province, religion_important, age, income_family, completed_university, married, employed) %>%
  summarise(n=n()) %>% 
  mutate(prop = n /sum(n))    

                                                                                # 
# census_data <- census_data %>% 
#   mutate(age=round(age)) %>% 
#   select(age, total_children, is_male, hh_size, income_family, province, education, religion_importance, religion_participation, language_home)
# census_data <- na.omit(census_data)
# summary(census_data) 
# #tells Rstudio to omit all rows of data with NA in the variables of interest
```


<Beyond the original cleaning process, the census data was further cleaned by selecting 10 important variables that could be important to determine the vote of individuals. For the variables income_family the data was converted to numeric values of levels of income instead of categorical values to be easier for computations. The data was also then cleaned by omitting any rows of data that had missing values in these variables. Age is defined as the average age of the respondent rounded to the nearest integer, while gender is the identified gender of the individual. 
> ]

<Here is a resource for grabbing the CES2019 data: [https://awstringer1.github.io/sta238-book/section-short-tutorial-on-pulling-data-for-assignment-1.html#section-canadian-election-study](https://awstringer1.github.io/sta238-book/section-short-tutorial-on-pulling-data-for-assignment-1.html#section-canadian-election-study)>

```{r, include = FALSE}

# Here you can load in and clean the survey data (you may need to do the cleaning in a separate R script). 
# First, if you don't already have it, install the devtools package:
# install.packages("devtools")

# Now use devtools to install the cesR package directly from Github:
# devtools::install_github("hodgettsp/cesR")

# Load it like any other package:
#library(cesR)

# There are many different CES datasets, and they have unique codes. 
# See them with the get_cescodes() function:

#get_cescodes()

# Now pick one, let's try ces2019_phone

#get_ces("ces2019_phone")

#survey_data <- ces2019_phone



# Alternative to what is in the comments above, I have locally loaded
# and (mildly) cleaned the CES2019 phone data and have included it in here.
# We can load it in:
survey_data <- read_csv("ces2019-phone_clean.csv")

```


```{r, include = FALSE}

#### You will need to update/clean the code below based off the variables you want to use in your poststratification.
survey_data %>% mutate(voted_2019 = ifelse(p2 == 1,1,0)) %>% select(voted_2019)

survey_data_LARGE <- 
  survey_data %>% 
  mutate(vote_liberal = ifelse(p3==1,1,0),
         age=case_when(
           age >= 18 & age <=29 ~ "ages 18 to 29",
           age >= 30 & age <=44 ~ "ages 30 to 44",
           age >= 45 & age <= 59 ~ "ages 45 to 59",
           age >= 60 ~ "ages 60 plus"
         ),
         province = case_when(
           q4 <= 6 ~ "East",
           q4 > 6 ~ "West",
         ),
         completed_university = ifelse (q61 >= 9, 1,0),
         religion_important = ifelse (q63 == 1 | q63 == 2, 1,0),
         en_first_language = ifelse(q67 == 1,1,0),
          income_family = case_when(
          q69 < 25000 ~ "Less than $25,000",
          q69 >= 25000 & q69 < 50000 ~ "$25,000 to $49,999",
          q69 >= 50000 & q69 < 75000 ~ "$50,000 to $74,999",
          q69 >= 75000 & q69 < 100000 ~ "$75,000 to $99,999",
          q69 >= 100000 & q69 < 125000 ~ "$100,000 to $ 124,999",
          q69 >= 125000 ~ "$125,000 and more"
          ),
         married = case_when(
           p50 == 1 ~ "Married",
           p50 == 1 || 2 || 3|| 4|| 5 || 6 ~ "not married"
           ),
        employed = case_when(
          q68 >= 1 & q68 <=3 ~ 1,
          q68 < 1 | q68 > 3 ~ 0
        )
         ) %>% 
dplyr::select(vote_liberal, age, province, completed_university, religion_important, income_family, married, employed)

survey_data_LARGE <- na.omit(survey_data_LARGE)
                                              

```


<Remember, you may want to use multiple datasets here, if you do end up using multiple data sets, or merging the data, be sure to describe this in the cleaning process and be sure to discuss important aspects of all the data that you used.>

** IMPORTANT VARIABLES: vote_liberal (response variable), province, pref_party, (age), party_2015 (...any more that we want to especially focus on) will be especially
informative; particular provinces tend to lean certain ways politically; the preferred party variable is directly indicative of voters' preferences; typically most voters will vote the same way election after election (SOURCE) so information regarding the previous election's voting record is expected to be very informative.
** OTHER VARIABLES TO LOOK OUT FOR: income, perceived winners, opinion_fedeconomy and opinion_econonmy, variables related to immigration, refugees, defense, and crime typically reflect partisan issues (SOURCE) and are expected to also be informative --> can describe this more in depth if needed

There are alot of redundent variabels and in the cleaning process we removed varibles that seemd to be overlapping with others by using the select function.
                                          
                                          
                                             


```{r, include=FALSE}

# Use this to calculate some summary measures. 
library(knitr)

survey_data %>% 
  summarise("Avg" = mean(age), "StD" = sd(age), "n" = length(age), "StdError" = StD/sqrt(n)) %>%
  rename("Average" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data Age")

survey_data %>% 
  summarise("Avg" = mean(is_male), "StD" = sd(is_male), "n" = length(is_male), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion Male" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data is_male")

census_data %>% 
  summarise("Avg" = mean(age), "StD" = sd(age), "n" = length(age), "StdError" = StD/sqrt(n)) %>%
  rename("Average" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Census Data Age")

census_data %>% 
  summarise("Avg" = mean(is_male), "StD" = sd(is_male), "n" = length(is_male), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion Male" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Census Data is_male")





```


<Include a description of the numerical summaries. Remember you can use `r ` to use inline R code.>
                                                        
                                                        
```{r, echo = TRUE}

# Use this to create some plots. Should probably describe both the sample and population.
hist(survey_data$age)
hist(survey_data$is_male)

hist(census_data$age)
hist(census_data$is_male)

```

<Include a clear description of the plot(s). I would recommend one paragraph for each plot.> 


## Methods

<Include some text introducing the methodology, maybe restating the problem/goal of this analysis.>


### Model Specifics
<Here you can describe your regression model>
**USING LOGISITIC MODEL TO BEGIN --> 
                                                        
<I will (incorrectly) be using a linear regression model to model the proportion of voters who will vote for Donald Trump. This is a naive model. I will only be using age, which is recorded as a numeric variable, to model the probability of voting for Donald Trump. The simple linear regression model I am using is:> 

                                                        
                                                        
$$ y = \beta_0+\beta_1  x_{age} + \epsilon$$

<Where $y$ represents the ....  $\beta_0$ represents....>

```{r, include=FALSE}

# Creating the Model
test <- glm(vote_liberal~age + as.factor(province)  + as.factor(elec_interest) + as.factor(lean_party) + as.factor(pref_party), survey_data_LARGE, family=binomial)
summary(test)

#Removed as.factor(pref_party) because was producing NA

voting_model_1 <- glm(vote_liberal ~ age + as.factor(province) + as.factor(religion_important) + as.factor(income_family) + as.factor(completed_university)+as.factor(married) + as.factor(employed), survey_data_LARGE, family = binomial)
summary(voting_model_1)

sel.var.bic <- step(voting_model_1, trace = 0, k = log(length(survey_data_LARGE$vote_liberal)), direction = "both") 
select_var_bic<-attr(terms(sel.var.bic), "term.labels")
select_var_bic
#suggests model with province, completed university, and employed
sel.var.aic <- step(voting_model_1, trace = 0, k = 2, direction = "both") 
select_var_aic<-attr(terms(sel.var.aic), "term.labels")
select_var_aic
#suggests model with province, religion important, completed university, married, employed
bic_model <- glm(vote_liberal ~ as.factor(province) + as.factor(completed_university)+ as.factor(employed), survey_data_LARGE, family = binomial)
summary(bic_model)
aic_model <- glm(vote_liberal ~ as.factor(province) + as.factor(religion_important) +as.factor(completed_university)+ as.factor(married) + as.factor(employed), survey_data_LARGE, family = binomial)
summary(aic_model)

##poststratification -- unsure if i did this right
updated_census_data1$estimate <- bic_model %>% 
  predict(newdata = updated_census_data1, type="response")

estimated_data <- updated_census_data1 %>% 
  mutate(liberal_prediction_prop = estimate*prop) %>% 
  summarize(liberal_prediction = sum(liberal_prediction_prop))
```


## Post-Stratification 

<Here you should explain the poststratification process>

<In order to estimate the proportion of voters.....>

<To put math/LaTeX inline just use one set of dollar signs. Example: $\hat{y}^{PS}$ >

<To put math on its own line use two sets of dollar signs:>

$$ include.your.mathematical.model.here.if.you.have.some.math.to.show $$


All analysis for this report was programmed using `R version 4.0.2`. 



## Results 

```{r, include=FALSE}

# Creating the Model
model <- lm(vote_liberal ~ age, data=survey_data)

# Model Results (to Report in Results section)
# summary(model)
# OR
# broom::tidy(model)
```

```{r, include=FALSE}

# Here I will perform the post-stratification calculation
census_data_counts <- census_data %>% 
  group_by(age) %>% 
  summarise(n=n())

census_data_counts$estimate <-
  model %>%
  predict(newdata = census_data_counts)

census_data_counts %>% 
  mutate(liberal_predict_prop = estimate*n) %>%
  summarise(liberal_predict = sum(liberal_predict_prop)/sum(n))

```

<Here you present your results. You may want to put them into a well formatted table. Be sure that there is some text describing the results.>


<Note: Alternatively you can use the `knitr::kable` function to create a well formatted table from your code. See here: [https://rmarkdown.rstudio.com/lesson-7.html](https://rmarkdown.rstudio.com/lesson-7.html).>



<Remember you can use `r ` to use inline R code.>


```{r, include = FALSE}

# Here you can include some relevant visualizations.


```

<Include an explanation/interpretation of the visualizations. Make sure to comment on the appropriateness of the assumptions/results.>

## Conclusions

<Here you should give a summary of the Hypotheses, Methods and Results>

<Highlight Key Results.>

<Talk about big picture.>

<Comment on any Weaknesses.>

<Comment on Future Work/Next Steps>

<End with a concluding paragraph to wrap up the report.>


## Bibliography

1. Grolemund, G. (2014, July 16) *Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/articles_intro.html](https://rmarkdown.rstudio.com/articles_intro.html). (Last Accessed: January 15, 2021) 

2. Dekking, F. M., et al. (2005) *A Modern Introduction to Probability and Statistics: Understanding why and how.* Springer Science & Business Media.

3.  Allaire, J.J., et. el. *References: Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/docs/](https://rmarkdown.rstudio.com/docs/). (Last Accessed: January 15, 2021) 
