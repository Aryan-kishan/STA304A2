---
title: "Informative Title Name"
author: "GROUP NUMBER: ADD YOUR NAMES HERE"
date: November 24, 2022
subtitle: STA304 - Assignment 2
output:
  pdf_document: default
---

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(openintro)
library(tidyverse)
library(MASS)
library(car)
```



## Introduction

  
The main objective of this report is to use a regression model with post-stratification to predict the overall popular vote for the upcoming Canadian federal election (tentatively 2025).

   For the analysis involved in this report, we will use two types of data — the census data and the survey data. The 2017 General Social Survey or GSS will serve as our census data, this includes every non-institutionalized individual over the age of 15 that is residing in one of the ten provinces of Canada. This 2017 GSS data was collected from February 2nd to November 30th, 2017 via telephone. The 2019 Canadian Election Study (CES) phone survey will serve as our survey data, this includes Canadian citizens and permanent residents aged 18 and above. This data was collected during and after the 2019 Canadian federal election through computer-assisted telephone interviews.
   
   This analysis is important because we will combine a multiple logistic regression model with post-stratification. Here, post-stratification will allow us to adjust the weights of each of the predictor variables to represent the population. This would make our final predictive model built using sample data more accurate. More specifically, the variables “Province” , “University Completion”, and “Employment” will be used to conduct post-stratification.
   
   The research question for our multiple logistic regression model with post stratification can be framed as follows: “Are province, university completion, and employment factors that predict if a person will vote for the Liberal Party of Canada?”.
   
   Furthermore, we can represent this question in the form of a null and alternative hypothesis. Here the null hypothesis states that none of the predictive covariates have a statistically significant relationship with our dependent variable. On the other hand, the alternative hypothesis states that at least one predictive covariate has a statistically significant relationship with our dependent variable.
  
$$H_0:\beta_Province = \beta_UniversityCompletion = \beta_Employment = 0$$
$$H_0:\beta_Province = \beta_UniversityCompletion = \beta_Employment \neq 0$$
 
   Overall, this hypothesis test is important because it will help us determine whether our model is statistically significant and whether it can actually predict if an individual will vote for the Liberal Party of Canada.
   
   Here, “Province” refers to the province of residence of the individual, “University Completion” is a binary variable that indicates whether or not the person has attained a university degree, and “Employment” is a binary variable that indicates whether or not the individual has worked in the last week.
   
Lastly, our report will contain the following sections: “Data”, “Methods”, “Results”, “Conclusion” and “Bibliography”. 




## Data

<The 2017 General Social Survey data is a sample survey with a cross-sectional design, facilitated from February 2nd through to November 30th, 2017. The target population of the survey is all non-institutionalized persons above the age of 15, living in Canada. The survey uses telephone numbers combined with Statistics Canada’s Address Register to collect data via telephone. The data is subject to sampling and non-damping errors. The data collected isused to meet two primary objectives; to monitor changes in living conditions and well-being of Canadian individuals and to gather information on specific social policy issues of current or arising interest. In order to meet these objectives data collected by the GSS contains core content and classification variables. The core content data contains information about individuals living conditions and well-being to help inform specific policies. Classification variables such as age, income, education, marital status, and sex help to classify population groups to better analyze the core data within them. In order to collect the data each of the ten provinces in Canada was divided into strata, and within the ten provinces, many of the Census Metropolitan Areas were considered separate strata, for a total of 27 strata. A simple random sample without replacement of records was performed within each stratum. The data was collected via computer-assisted telephone interviews. Responses from the interviews were entered directly into computers as the interview went on. The data was then electronically transmitted to Ottawa. Several questions in the data allowed for write-in responses. These responses were either categorized into existing groups or left in “other specify” if a match was not possible within the existing data. As the survey was conducted the computer would create edits and identify “out of range" values that the interviewer could clarify and resolve with the individual being surveyed. If issues were unable to be resolved the errors were forwarded to the Head Office for resolution. Non-response was not permitted for questions that the survey later required to use for the weighting of individuals. In the case where important values were missing values were imputed.  In 2017, personal income information was not obtained through the survey but rather collected from tax data for the respondent. Finally, the timing that respondents experienced given life events was very important to the survey and was collected from individuals’ recollections. Originally the month and year of a particular event were asked, however, if individuals were unable or refused to provide such information then the age at which he or she experienced the event is asked. For some situations, the answers required imputation to derive the age, month, and year of the occurrence of events for individuals.>

In the 2019 Canadian Election Study, a Phone survey was conducted to gather information on the underlying reasons why people make the voting decisions they do, to evaluate what does and does not change during the campaign from one election to another, and to highlight similarities and differences between elections and voting in Canada to other democratic countries. The study was conducted on Canadian citizens and permanent residents age 18 or older during and after the 2019 federal election. The data was collected through computer-assisted telephone interviews, consisting of 4021 cases and 278 variables. The sample consisted of 66% wireless telephone numbers and 34% landline telephone numbers.>


```{r, include = FALSE}

# Here you can load in and clean the census data (you may need to do the cleaning in a separate R script). 

census_data <- read_csv("gss_clean.csv")
 
updated_census_data <- census_data %>% 
  mutate(province = 
           case_when(
             province == "Quebec" ~ "East",
             province == "Ontario" ~ "East",
             province == "New Brunswick" ~ "East",
             province == "Newfoundland and Labrador" ~ "East",
             province == "Nova Scotia" ~ "East",
             province == "Prince Edward Island" ~ "East",
             province == "Alberta" ~ "West",
             province == "Manitoba" ~ "West",
             province == "Saskatchewan" ~ "West",
             province == "British Columbia" ~ "West"),
         religion_important = case_when(
           regilion_importance == "Very important" ~ 1,
           regilion_importance == "Somewhat important" ~ 1,
           regilion_importance == "Not very important" ~ 0,
           regilion_importance == "Not at all important" ~ 0,
           regilion_importance == "Don't know" ~ 0
         ),
         age=case_when(
           age >= 18 & age <=29 ~ "ages 18 to 29",
           age >= 30 & age <=44 ~ "ages 30 to 44",
           age >= 45 & age <= 59 ~ "ages 45 to 59",
           age >= 60 ~ "ages 60 plus",
         ),
         completed_university = case_when(
           education == "Bachelor's degree (e.g. B.A., B.Sc., LL.B.)" | 
             education == "University certificate or diploma below the bachelor's level" | 
             education == "University certificate, diploma or degree above the bach..." ~ 1,
           education == "College, CEGEP or other non-university certificate or di..." | 
             education == "High school diploma or a high school equivalency certificate" |
             education == "Less than high school diploma or its equivalent" |
             education == "Trade certificate or diploma" ~ 0
         ),
         married = ifelse(marital_status == "Married", 1,0),
         employed = ifelse(worked_last_week == "Yes", 1,0),
         
         
  ) %>%  dplyr::select (province, religion_important, age, income_family, completed_university, married, employed)
updated_census_data <- na.omit(updated_census_data)

updated_census_data1 <- updated_census_data %>%
  group_by(province, religion_important, age, income_family, completed_university, married, employed) %>%
  summarise(n=n()) %>% 
  mutate(prop = n /sum(n))    

```


<Beyond the original cleaning process, the census data was further cleaned by changing the values of variables to be easier for computation and reduced to contain only important variables with individuals with all selected variable values recorded. The variable province was mutated to two different categories of east and west to be easier for computation. Religious importance is converted to a dummy variable with a value of 1 if religion is important at all and 0 if not. Age is mutated into categories representing the same age categories as the survey data. Education is also converted to a dummy variable with a value of 1 for a University certificate, diploma or degree above the bachelor's and 0 for College, CEGEP or other non-university certificate or diploma. The variable married and employed are also converted to dummy variables with a value of 1 if the individual is married or employed and 0 otherwise. The data was then reduced by selecting to only contain variables province, religion_important, age, income_family, completed_university, married, and employed. The data then was lastly cleaned by omitting any rows of data that have NA values in the selected variables.>

<Here is a resource for grabbing the CES2019 data: [https://awstringer1.github.io/sta238-book/section-short-tutorial-on-pulling-data-for-assignment-1.html#section-canadian-election-study](https://awstringer1.github.io/sta238-book/section-short-tutorial-on-pulling-data-for-assignment-1.html#section-canadian-election-study)>

```{r, include = FALSE}

# Here you can load in and clean the survey data (you may need to do the cleaning in a separate R script). 
# First, if you don't already have it, install the devtools package:
# install.packages("devtools")

# Now use devtools to install the cesR package directly from Github:
# devtools::install_github("hodgettsp/cesR")

# Load it like any other package:
#library(cesR)

# There are many different CES datasets, and they have unique codes. 
# See them with the get_cescodes() function:

#get_cescodes()

# Now pick one, let's try ces2019_phone

#get_ces("ces2019_phone")

#survey_data <- ces2019_phone



# Alternative to what is in the comments above, I have locally loaded
# and (mildly) cleaned the CES2019 phone data and have included it in here.
# We can load it in:
survey_data <- read_csv("ces2019-phone_clean.csv")

```


```{r, include = FALSE}

#### You will need to update/clean the code below based off the variables you want to use in your poststratification.

survey_data_LARGE <- 
  survey_data %>% 
  mutate(vote_liberal = ifelse(p3==1,1,0),
         age=case_when(
           age >= 18 & age <=29 ~ "ages 18 to 29",
           age >= 30 & age <=44 ~ "ages 30 to 44",
           age >= 45 & age <= 59 ~ "ages 45 to 59",
           age >= 60 ~ "ages 60 plus"
         ),
         province = case_when(
           q4 <= 6 ~ "East",
           q4 > 6 ~ "West",
         ),
         completed_university = ifelse (q61 >= 9, 1,0),
         religion_important = ifelse (q63 == 1 | q63 == 2, 1,0),
         en_first_language = ifelse(q67 == 1,1,0),
          income_family = case_when(
          q69 < 25000 ~ "Less than $25,000",
          q69 >= 25000 & q69 < 50000 ~ "$25,000 to $49,999",
          q69 >= 50000 & q69 < 75000 ~ "$50,000 to $74,999",
          q69 >= 75000 & q69 < 100000 ~ "$75,000 to $99,999",
          q69 >= 100000 & q69 < 125000 ~ "$100,000 to $ 124,999",
          q69 >= 125000 ~ "$125,000 and more"
          ),
         married = case_when(
           p50 == 1 ~ "Married",
           p50 == 1 || 2 || 3|| 4|| 5 || 6 ~ "not married"
           ),
        employed = case_when(
          q68 >= 1 & q68 <=3 ~ 1,
          q68 < 1 | q68 > 3 ~ 0
        )
         ) %>% 
dplyr::select(en_first_language, vote_liberal, age, province, completed_university, religion_important, income_family, married, employed)

survey_data_LARGE <- na.omit(survey_data_LARGE)
                                              

```


<The important variables we will be using for post-stratification in the model are vote_liberal, age, province, completed_university, religion_important, income_family, married, and employed. There are a lot of redundant variables in the survey data set and so in the cleaning process, we removed variables that seemed to be overlapping with others by using the select function. The variables we selected to use are especially informative as to which way an individual tends to lean politically. Age is a categorical variable for the age of the individual over 18. Province points to whether an individual lives in the east or west of Canada. Completed University is a dummy variable that has a value of one if an individual obtained university certification. Religion_important is another dummy variable which has value one if religion is important to the individual. en_first_language is another dummy variable which has value one if the individual has English as their first language and 0 otherwise.  Income_family is a categorical variable that depicted the income of the individual. The last two variables denoted married and employed are also dummy variables with values 1 if the individual is married/employed and 0 otherwise.  All of these variables will be important in predicting the vote_liberal dummy variable which has a value of 1 when an individual votes liberal and 0 otherwise. >                                     
                                             


```{r, include=FALSE}

# Use this to calculate some summary measures. 
library(knitr)



survey_data_LARGE %>% 
  summarise("Avg" = mean(vote_liberal), "StD" = sd(vote_liberal), "n" = length(vote_liberal), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion Vote_liberal" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data vote_liberal")


survey_data_LARGE %>% 
  summarise("Avg" = mean(completed_university), "StD" = sd(completed_university), "n" = length( completed_university), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion Completed_university" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data Completed_university")


survey_data_LARGE %>% 
  summarise("Avg" = mean(religion_important), "StD" = sd(religion_important), "n" = length(religion_important), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion religion_important" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data religion_important")


survey_data_LARGE %>% 
  summarise("Avg" = mean(employed), "StD" = sd(employed), "n" = length(employed), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion employed" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data employed")


survey_data_LARGE %>% 
  summarise("Avg" = mean(en_first_language), "StD" = sd(en_first_language), "n" = length(en_first_language), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion en_first_language" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Survey Data en_first_language")







updated_census_data %>% 
  summarise("Avg" = mean(completed_university), "StD" = sd(completed_university), "n" = length( completed_university), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion Completed_university" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Census Data Completed_university")


updated_census_data %>% 
  summarise("Avg" = mean(religion_important), "StD" = sd(religion_important), "n" = length(religion_important), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion religion_important" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Census Data religion_important")


updated_census_data %>% 
  summarise("Avg" = mean(employed), "StD" = sd(employed), "n" = length(employed), "StdError" = StD/sqrt(n)) %>%
  rename("Proportion employed" = "Avg", "Standard Deviation" = "StD", "Number of Observations" = "n", "Standard Error" = "StdError") %>%
  kable(caption = "Statistics about Census Data employed")







```


< The numerical summaries above look at the proportion of the population or survey sample that exhibits super characteristics. The summaries also state the devotion from the proportion, the number of observations or individuals analyzed and the standard error. In looking at the vote_liberal variable in the survey data we can see that from 1769 individuals approximately 31% of the sample voted liberal. We can also see from the survey data that approximately 43% of the survey sample completed university, whereas in the population data of 18766 individuals only approximately 32% completed university. In investigating another variable, religion_important, we can see that in the survey sample a whopping 72% reported religion being of importance to them, whereas in the population data a smaller 64% reported religion being of importance. In the survey data for employment, we can see that only approximately 54% of individuals were employed. The population census data from employment is very similar to the sample with approximately 52% of individuals being employed. From the survey data, we also see that roughly 69% of individuals have English as their first language. In comparing the survey and census data the census data consistently has a lower standard error which makes sense for the increase in observations. The standard deviation of variables between the population and sample is relatively similar. >

                              
                                                        
                                                        
```{r, echo = TRUE}

# Use this to create some plots. Should probably describe both the sample and population.
hist(survey_data_LARGE$vote_liberal)
hist(survey_data_LARGE$completed_university)

hist(updated_census_data$completed_university)


```

<The first plot titled “Histogram of survey_data_LARGE$vote_liberal” shows the frequencies of liberal vote values. Since the variable vote_liberal is a dummy variable it can only take values 0 and 1 which gives us the two columns at 0 and 1 on the x-axis. From the plot, we can see the survey data contains substantially more non-liberal voters than liberal voters. 

The second Histogram titled “Histogram of survey_data_LARGE$completed_university” shows the frequencies of individuals in the survey having completed a university degree. We can see from the plot that there is almost an equal amount of university and non-university graduates. 

The third Histogram titled “Histogram of updated_census_data$completed_university” depicts the frequency of individuals in the census population having completed a university degree. We can see from the plot that there is a much smaller proportion of university graduates than non-grads in the population. This is interesting to compare to the survey sample which had a more similar proportion of this characteristic. > 



## Methods

<Include some text introducing the methodology, maybe restating the problem/goal of this analysis.>


### Model Specifics
<Here you can describe your regression model>
<-	Goal of this report is to” predict the overall popular vote of the next Canadian federal election”
-	Survey data from CES2019 is utilized to create a model for election results
o	The outcome variable that will be modeled will be binary and reflect whether or not a vote will be cast in favour of the incumbent Liberal Party of Canada based on a set of variables.
o	The predictions from this model can then be extrapolated to a more representative population in a process called post-stratification, in which datapoints from GSS that are characteristically similar to data points in the CES2019 can be utilised to calculate a proportion which can then be applied to the estimated values from the model

-	A multiple logistic model was selected over a linear model as the binary outcome variable produces a situation where responses are on complete opposite sides from one another which would result in the linear regression treating many of those variables as outliers. A logistic model differs from a linear model in that it considers the response as a binary choice. As well, a logistic model produces an estimate of the odds of a predicted response rather than the explicit predicted response that is produced from a linear model. The odds of a logistic model are denoted by $log(\frac{p}{1-p})$, where $p$ represents the probability of the outcome.
>
$$ log(\frac{p}{1-p}) = \beta_0 + \beta_1  x_{province} + \beta_2  x_{university} + \beta_3  x_{employed}   $$                                               
  
 <The chosen model, shown above, was constructed by attempting to minimize a metric called Bayesian Information Criterion (BIC) which penalizes models for having to many variables and thus seeks to create the best model with the least number of variables. BIC is minimised through a process called stepwise selection which iterates between adding variables and removing them from the model until a minimum is determined. The presented model originated from a larger model that contained all relevant variables which were determined to be relevant and were appropriate for post-stratification. Namely, this initial model includes age, province, religion importance, family income, university completion, marital status, and employment. The model produced from the BIC stepwise selection process comprised of province, university completion, and employment.>

 

        
                                                        

<Where $y$ represents the ....  $\beta_0$ represents....>

```{r, include=FALSE}

# Creating the Model
test <- glm(vote_liberal~age + as.factor(province)  + as.factor(elec_interest) + as.factor(lean_party) + as.factor(pref_party), survey_data_LARGE, family=binomial)
summary(test)

#Removed as.factor(pref_party) because was producing NA

voting_model_1 <- glm(vote_liberal ~ age + as.factor(province) + as.factor(religion_important) + as.factor(income_family) + as.factor(completed_university)+as.factor(married) + as.factor(employed), survey_data_LARGE, family = binomial)
summary(voting_model_1)

sel.var.bic <- step(voting_model_1, trace = 0, k = log(length(survey_data_LARGE$vote_liberal)), direction = "both") 
select_var_bic<-attr(terms(sel.var.bic), "term.labels")
select_var_bic
#suggests model with province, completed university, and employed
sel.var.aic <- step(voting_model_1, trace = 0, k = 2, direction = "both") 
select_var_aic<-attr(terms(sel.var.aic), "term.labels")
select_var_aic
#suggests model with province, religion important, completed university, married, employed
bic_model <- glm(vote_liberal ~ as.factor(province) + as.factor(completed_university)+ as.factor(employed), survey_data_LARGE, family = binomial)
summary(bic_model)
aic_model <- glm(vote_liberal ~ as.factor(province) + as.factor(religion_important) +as.factor(completed_university)+ as.factor(married) + as.factor(employed), survey_data_LARGE, family = binomial)
summary(aic_model)

##poststratification -- unsure if i did this right
updated_census_data1$estimate <- bic_model %>% 
  predict(newdata = updated_census_data1, type="response")

estimated_data <- updated_census_data1 %>% 
  mutate(liberal_prediction_prop = estimate*prop) %>% 
  summarize(liberal_prediction = sum(liberal_prediction_prop))
```
TABLE
| Model | Number of Predictors | $\Delta AIC | $\Delta BIC$ |
|------|------|------| ---- |
| Original Model |  $8$    |  0  | 0 |
| BIC Model     |   $3$   | `r round(AIC(voting_model_1) - AIC(bic_model),1)` | `r round(BIC(voting_model_1) - BIC(bic_model),1)` |
| AIC Model     |   $5$   | `r round(AIC(voting_model_1) - AIC(aic_model),1)` | `r round(BIC(voting_model_1) - BIC(aic_model),1)`|


## Post-Stratification 
  
 
## Post-Stratification 
o-	In the case of this model, post stratification will be applied by categorizing the data in the CES data such that it matches data in GSS which is a much larger data set. From this, proportions of each category can be calculated and applied to estimates generated by the model previously developed. Post-stratification would thus seek to adjust estimates such that over- or under- represented data points from the survey are adjusted to reflect their prevalence in a wider context. The assumption of post-stratification is that the census level data used is truly more representative and is less biased than the surveyed data..
o	This is mathematically represented by  

## Addressing	Assumptions of the Logisitic Model

There are four assumptions present in a Logistic model. First, due to the nature of the construction of the logistic model, the response variable must be a binary categorical variable. This assumption is was addressed by utilising a dummy variable to represent the particular political party which represented whether or not that observation included a vote for that party. The next assumption requires linearity between the log odds $log(\frac{p}{1-p})$ and any continuous variables. However, since the model's presented above do not include continuous variables, this assumption is (not important). Third, there is an assumption about the lack of multicollinearity which can be tested by analysing a metric called the Variance Inflation Factor for each variable. As a rule of thumb, any predictor variable with a VIF greater to 5 to 10 can be classified as being correlated with other predictor variables. Table. VIF depicts the VIF of predictor variables from the BIC model and that
- Outcome is binary
- Linearity in the logit (log odds) for continuous variables
- Absence of multicollinearity
- Lack of strongly influential outliers

### Multicollinearity
Table. VIF
| Variables | VIF | 
|------|------|
| Province | 1.002 |    
| Completed University    |    1.019  | 
| Employed     |   1.021   | 

## Results 

```{r, include=FALSE}

# Creating the Model
model <- lm(vote_liberal ~ age, data=survey_data)

# Model Results (to Report in Results section)
# summary(model)
# OR
# broom::tidy(model)
```

```{r, include=FALSE}

# Here I will perform the post-stratification calculation
census_data_counts <- census_data %>% 
  group_by(age) %>% 
  summarise(n=n())

census_data_counts$estimate <-
  model %>%
  predict(newdata = census_data_counts)

census_data_counts %>% 
  mutate(liberal_predict_prop = estimate*n) %>%
  summarise(liberal_predict = sum(liberal_predict_prop)/sum(n))

```

<Here you present your results. You may want to put them into a well formatted table. Be sure that there is some text describing the results.>


<Note: Alternatively you can use the `knitr::kable` function to create a well formatted table from your code. See here: [https://rmarkdown.rstudio.com/lesson-7.html](https://rmarkdown.rstudio.com/lesson-7.html).>



<Remember you can use `r ` to use inline R code.>


```{r, include = FALSE}

# Here you can include some relevant visualizations.


```

<Include an explanation/interpretation of the visualizations. Make sure to comment on the appropriateness of the assumptions/results.>

## Conclusions

<Here you should give a summary of the Hypotheses, Methods and Results>

<Highlight Key Results.>

<Talk about big picture.>

<Comment on any Weaknesses.>

<Comment on Future Work/Next Steps>

<End with a concluding paragraph to wrap up the report.>


## Bibliography

1. Grolemund, G. (2014, July 16) *Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/articles_intro.html](https://rmarkdown.rstudio.com/articles_intro.html). (Last Accessed: January 15, 2021) 

2. Dekking, F. M., et al. (2005) *A Modern Introduction to Probability and Statistics: Understanding why and how.* Springer Science & Business Media.

3.  Allaire, J.J., et. el. *References: Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/docs/](https://rmarkdown.rstudio.com/docs/). (Last Accessed: January 15, 2021) 
